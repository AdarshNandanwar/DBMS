drop database if exists db212lab5;
create database db212lab5;
use db212lab5;

CREATE TABLE TEAMS(T_ID VARCHAR(10) PRIMARY KEY, TEAM VARCHAR(50));

CREATE TABLE ROLE_TABLE(ROLE_ID VARCHAR(10) PRIMARY KEY, ROLE VARCHAR(50));

CREATE TABLE INFORMATION(PLAYER_ID VARCHAR(10) PRIMARY KEY, T_ID VARCHAR(10), ROLE_ID VARCHAR(10), FOREIGN KEY(T_ID) REFERENCES TEAMS(T_ID), FOREIGN KEY(ROLE_ID) REFERENCES ROLE_TABLE(ROLE_ID));

CREATE TABLE PLAYERS(PLAYER_ID VARCHAR(10) PRIMARY KEY, PLAYER_NAME VARCHAR(100), RUNS INT, WICKETS INT, AWARDS INT, FOREIGN KEY(PLAYER_ID) REFERENCES INFORMATION(PLAYER_ID));

CREATE TABLE PLAYER_GRADE(GRADE VARCHAR(5) PRIMARY KEY, MIN_RUNS INT, MAX_RUNS INT, MIN_WICKETS INT, MAX_WICKETS INT);

CREATE TABLE CONTRACT(PLAYER_ID VARCHAR(10), T_ID VARCHAR(10), START_DATE DATE, END_DATE DATE, PRIMARY KEY(PLAYER_ID, T_ID), FOREIGN KEY(PLAYER_ID) REFERENCES INFORMATION(PLAYER_ID), FOREIGN KEY(T_ID) REFERENCES TEAMS(T_ID));



INSERT INTO TEAMS VALUES('01', 'CSK');
INSERT INTO TEAMS VALUES('02', 'MI');
INSERT INTO TEAMS VALUES('03', 'SRH');
INSERT INTO TEAMS VALUES('04', 'DC');
INSERT INTO TEAMS VALUES('05', 'K11P');
INSERT INTO TEAMS VALUES('06', 'KKR');
INSERT INTO TEAMS VALUES('07', 'RR');
INSERT INTO TEAMS VALUES('08', 'RCB');
INSERT INTO TEAMS VALUES('09', 'PW');
INSERT INTO TEAMS VALUES('10', 'BITS11');

INSERT INTO ROLE_TABLE VALUES('101', 'BOWLER');
INSERT INTO ROLE_TABLE VALUES('102', 'ALL-ROUNDER');
INSERT INTO ROLE_TABLE VALUES('103', 'BATSMAN');
INSERT INTO ROLE_TABLE VALUES('104', 'WICKET-KEEPER');
 
INSERT INTO INFORMATION VALUES('27611', '01', '103');
INSERT INTO INFORMATION VALUES('84606', '02', '103');
INSERT INTO INFORMATION VALUES('18271', '06', '104');
INSERT INTO INFORMATION VALUES('37519', '06', '104');
INSERT INTO INFORMATION VALUES('22302', '02', '103');
INSERT INTO INFORMATION VALUES('73944', '02', '104');
INSERT INTO INFORMATION VALUES('13715', '01', '103');
INSERT INTO INFORMATION VALUES('89618', '01', '102');
INSERT INTO INFORMATION VALUES('44908', '02', '102');
INSERT INTO INFORMATION VALUES('39984', '02', '102');
INSERT INTO INFORMATION VALUES('87483', '02', '102');
INSERT INTO INFORMATION VALUES('11206', '01', '101');
INSERT INTO INFORMATION VALUES('59965', '02', '102');
INSERT INTO INFORMATION VALUES('99978', '03', '101');
INSERT INTO INFORMATION VALUES('38390', '02', '101');
INSERT INTO INFORMATION VALUES('74987', '02', '101');
INSERT INTO INFORMATION VALUES('82464', '08', '101');
INSERT INTO INFORMATION VALUES('40550', '02', '101');
INSERT INTO INFORMATION VALUES('12816', '01', '102');
INSERT INTO INFORMATION VALUES('64549', '07', '102');
INSERT INTO INFORMATION VALUES('82935', '03', '103');
INSERT INTO INFORMATION VALUES('25264', '08', '102');
INSERT INTO INFORMATION VALUES('50350', '03', '103');
INSERT INTO INFORMATION VALUES('23816', '02', '101');
INSERT INTO INFORMATION VALUES('26549', '05', '102');
INSERT INTO INFORMATION VALUES('22535', '04', '103');


INSERT INTO PLAYERS VALUES('27611', 'DA Warner', 692, 0, 12);
INSERT INTO PLAYERS VALUES('84606', 'KL Rahul', 593, 0, 6);
INSERT INTO PLAYERS VALUES('18271', 'Q de Kock', 529, 0, 3);
INSERT INTO PLAYERS VALUES('37519', 'AB de Villiers', 442, 0, 0);
INSERT INTO PLAYERS VALUES('22302', 'SA Yadav', 424, 0, 0);
INSERT INTO PLAYERS VALUES('73944', 'MS Dhoni', 416, 0, 8);
INSERT INTO PLAYERS VALUES('13715', 'CA Lynn', 405, 0, 0);
INSERT INTO PLAYERS VALUES('89618', 'SR Watson', 398, 6, 0);
INSERT INTO PLAYERS VALUES('44908', 'SK Raina', 383, 7, 0);
INSERT INTO PLAYERS VALUES('39984', 'PA Patel', 373, 0, 2);
INSERT INTO PLAYERS VALUES('87483', 'PP Shaw', 353, 0, 0);
INSERT INTO PLAYERS VALUES('11206', 'S Smith', 282, 3, 1);
INSERT INTO PLAYERS VALUES('59965', 'AT Rayudu', 282, 1, 0);
INSERT INTO PLAYERS VALUES('99978', 'KA Pollard', 279, 5, 6);
INSERT INTO PLAYERS VALUES('38390', 'KD Karthik', 253, 0, 0);
INSERT INTO PLAYERS VALUES('74987', 'KH Pandya', 183, 2, 7);
INSERT INTO PLAYERS VALUES('82464', 'L Malinga', 180, 10, 0);
INSERT INTO PLAYERS VALUES('40550', 'N Pooran', 168, 7, 3);
INSERT INTO PLAYERS VALUES('12816', 'BA Stokes', 123, 10, 1);
INSERT INTO PLAYERS VALUES('64549', 'Mohammad Nabi', 115, 4, 0);
INSERT INTO PLAYERS VALUES('82935', 'C Gayle', 110, 8, 0);	

INSERT INTO CONTRACT VALUES('27611', '01', '2007-02-01', '2020-01-01');
INSERT INTO CONTRACT VALUES('84606', '02', '2007-04-03', '2019-05-03');
INSERT INTO CONTRACT VALUES('18271', '06', '2009-03-12', '2016-04-23');
INSERT INTO CONTRACT VALUES('37519', '06', '2007-04-21', '2019-02-11');
INSERT INTO CONTRACT VALUES('22302', '02', '2007-02-11', '2015-02-01');
INSERT INTO CONTRACT VALUES('22302', '06', '2016-05-14', '2020-01-11');
INSERT INTO CONTRACT VALUES('73944', '02', '2007-03-21', '2011-06-01');
INSERT INTO CONTRACT VALUES('73944', '04', '2012-05-22', '2016-01-01');
INSERT INTO CONTRACT VALUES('73944', '01', '2017-04-13', '2020-04-01');
INSERT INTO CONTRACT VALUES('13715', '01', '2008-04-12', '2019-03-12');
INSERT INTO CONTRACT VALUES('89618', '01', '2007-10-22', '2015-02-13');
INSERT INTO CONTRACT VALUES('44908', '02', '2009-11-23', '2017-02-01');
INSERT INTO CONTRACT VALUES('39984', '02', '2010-06-25', '2018-04-14');
INSERT INTO CONTRACT VALUES('87483', '02', '2009-07-12', '2019-01-01');
INSERT INTO CONTRACT VALUES('11206', '01', '2008-08-23', '2018-06-14');
INSERT INTO CONTRACT VALUES('59965', '02', '2008-11-11', '2016-01-01');
INSERT INTO CONTRACT VALUES('99978', '03', '2011-02-15', '2013-08-17');
INSERT INTO CONTRACT VALUES('38390', '02', '2012-01-21', '2017-01-01');
INSERT INTO CONTRACT VALUES('74987', '02', '2014-04-22', '2019-06-01');
INSERT INTO CONTRACT VALUES('82464', '08', '2012-03-25', '2016-01-01');
INSERT INTO CONTRACT VALUES('82464', '03', '2017-03-25', '2019-01-01');
INSERT INTO CONTRACT VALUES('40550', '02', '2016-02-25', '2022-04-18');
INSERT INTO CONTRACT VALUES('12816', '01', '2008-05-26', '2021-07-01');
INSERT INTO CONTRACT VALUES('64549', '07', '2007-06-11', '2017-12-01');
INSERT INTO CONTRACT VALUES('82935', '03', '2009-02-05', '2014-09-19');
INSERT INTO CONTRACT VALUES('82935', '02', '2015-01-02', '2018-06-13');
INSERT INTO CONTRACT VALUES('25264', '08', '2007-09-04', '2016-12-13');
INSERT INTO CONTRACT VALUES('50350', '03', '2015-12-02', '2016-06-01');
INSERT INTO CONTRACT VALUES('23816', '02', '2011-11-11', '2025-05-16');
INSERT INTO CONTRACT VALUES('26549', '05', '2012-12-26', '2024-11-01');
INSERT INTO CONTRACT VALUES('22535', '04', '2013-03-05', '2023-12-01');


INSERT INTO PLAYER_GRADE VALUES('01', 100, 200, 0, 3); 
INSERT INTO PLAYER_GRADE VALUES('02', 200, 300, 3, 6); 
INSERT INTO PLAYER_GRADE VALUES('03', 300, 400, 6, 9); 
INSERT INTO PLAYER_GRADE VALUES('04', 400, 1000, 9, 15); 


-- QUERIES START HERE

-- Q1
SELECT PLAYER_ID, TEAM FROM INFORMATION LEFT JOIN TEAMS USING(T_ID);

-- Q2
SELECT TEAM, COUNT(*) AS CNT 
FROM INFORMATION NATURAL JOIN TEAMS
GROUP BY T_ID
HAVING COUNT(*) = (
	SELECT MIN(CNT) 
	FROM (
		SELECT COUNT(*) AS CNT 
		FROM INFORMATION
		GROUP BY T_ID
	) AS CT
);

-- Q3
SELECT PLAYER_NAME, ROLE_ID FROM PLAYERS NATURAL JOIN INFORMATION NATURAL JOIN ROLE_TABLE;

-- Q4
SELECT TP.PLAYER_NAME, COUNT(*) FROM (
	SELECT PLAYER_NAME, RUNS FROM PLAYERS
	ORDER BY RUNS DESC LIMIT 5
) AS TP CROSS JOIN PLAYERS AS P2
WHERE TP.RUNS > P2.RUNS
GROUP BY TP.PLAYER_NAME
ORDER BY COUNT(*) DESC;

-- Q5
SELECT ROLE, ROLE_ID, MAX FROM (
	SELECT ROLE, MAX(RUNS) AS MAX
	FROM (
		SELECT ROLE_ID, ROLE FROM ROLE_TABLE WHERE ROLE = "BATSMAN"
	) AS RT NATURAL JOIN INFORMATION NATURAL JOIN PLAYERS
	UNION
	SELECT ROLE, MAX(WICKETS) AS MAX
	FROM (
		SELECT ROLE_ID, ROLE FROM ROLE_TABLE WHERE ROLE = "BOWLER"
	) AS RT NATURAL JOIN INFORMATION NATURAL JOIN PLAYERS
) AS T1 NATURAL JOIN ROLE_TABLE;

-- Q6
SELECT T_ID, TEAM FROM TEAMS LEFT JOIN INFORMATION AS I1 USING(T_ID)
WHERE PLAYER_ID IS NULL;

-- Q7
SELECT PLAYER_ID FROM (
	SELECT ROLE_ID FROM ROLE_TABLE WHERE ROLE = "BOWLER"
) AS RT NATURAL JOIN INFORMATION NATURAL JOIN CONTRACT
WHERE START_DATE <= CURDATE() AND CURDATE() <= END_DATE;

-- Q8
SELECT PLAYER_NAME, R1.ROLE, RUNS AS MR FROM PLAYERS AS P1 NATURAL JOIN INFORMATION NATURAL JOIN ROLE_TABLE AS R1 CROSS JOIN (
	SELECT ROLE, MAX(RUNS) AS MR FROM PLAYERS NATURAL JOIN INFORMATION NATURAL JOIN ROLE_TABLE
	GROUP BY ROLE
) AS T1
WHERE P1.RUNS=T1.MR AND R1.ROLE=T1.ROLE;

-- Q9
SELECT CNT, PLAYER_NAME, ROLE FROM (
	SELECT PLAYER_ID, COUNT(*) AS CNT FROM CONTRACT
	GROUP BY PLAYER_ID
	HAVING COUNT(*) > 1
) AS T1 NATURAL JOIN PLAYERS NATURAL JOIN INFORMATION NATURAL JOIN ROLE_TABLE;

-- Q10
SELECT TEAM, COUNT(*) AS Number_of_GameChangers FROM (
	SELECT T_ID FROM PLAYERS NATURAL JOIN INFORMATION NATURAL JOIN (
		SELECT * FROM ROLE_TABLE WHERE ROLE="BATSMAN"
	) AS R1 CROSS JOIN PLAYER_GRADE
	WHERE (MIN_RUNS<=RUNS AND RUNS<MAX_RUNS)
	AND (
		(GRADE=01 AND AWARDS>1) OR
		(GRADE=02 AND AWARDS>4) OR
		(GRADE=03 AND AWARDS>7) OR
		(GRADE=04 AND AWARDS>10)
	)
	UNION
	SELECT T_ID FROM PLAYERS NATURAL JOIN INFORMATION NATURAL JOIN (
		SELECT * FROM ROLE_TABLE WHERE ROLE="BOWLER"
	) AS R1 CROSS JOIN PLAYER_GRADE
	WHERE (MIN_WICKETS<=WICKETS AND WICKETS<MAX_WICKETS)
	AND (
		(GRADE=01 AND AWARDS>1) OR
		(GRADE=02 AND AWARDS>4) OR
		(GRADE=03 AND AWARDS>7) OR
		(GRADE=04 AND AWARDS>10)
	)
) AS T1 NATURAL JOIN TEAMS
GROUP BY TEAM;